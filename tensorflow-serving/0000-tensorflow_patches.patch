From 1cf5b8cdcc69b786d4324bc061c01e16fae81f6f Mon Sep 17 00:00:00 2001
From: Nishidha Panpaliya <npanpa23@in.ibm.com>
Date: Thu, 26 Nov 2020 08:42:08 +0000
Subject: [PATCH] Patches for TF 2.4

---
 WORKSPACE                                     |  1 +
 third_party/tensorflow/BUILD                  |  0
 .../tensorflow/tensorflow_patches.patch       | 73 +++++++++++++++++++
 3 files changed, 74 insertions(+)
 create mode 100644 third_party/tensorflow/BUILD
 create mode 100644 third_party/tensorflow/tensorflow_patches.patch

diff --git a/WORKSPACE b/WORKSPACE
index 57ed6505..47cc49d6 100644
--- a/WORKSPACE
+++ b/WORKSPACE
@@ -13,6 +13,7 @@ tensorflow_http_archive(
     name = "org_tensorflow",
     sha256 = "098733e15e227a6a55997295ca761a9a8e7169b64104ea86feb952e4e2ea0bc9",
     git_commit = "0b06f2927be226ffe44f47bfa9e03e4ea649d7f3",
+    patch = "//third_party/tensorflow:tensorflow_patches.patch",
 )
 
 load("@bazel_tools//tools/build_defs/repo:http.bzl", "http_archive")
diff --git a/third_party/tensorflow/BUILD b/third_party/tensorflow/BUILD
new file mode 100644
index 00000000..e69de29b
diff --git a/third_party/tensorflow/tensorflow_patches.patch b/third_party/tensorflow/tensorflow_patches.patch
new file mode 100644
index 00000000..7ca4f5fd
--- /dev/null
+++ b/third_party/tensorflow/tensorflow_patches.patch
@@ -0,0 +1,73 @@
+From 4a92d062df0a619f87b443af858a568207047301 Mon Sep 17 00:00:00 2001
+From: Nishidha Panpaliya <npanpa23@in.ibm.com>
+Date: Thu, 26 Nov 2020 08:40:39 +0000
+Subject: [PATCH] TF 2.4 patches
+
+---
+ tensorflow/tensorflow.bzl                   | 2 ++
+ third_party/gpus/find_cuda_config.py        | 2 ++
+ third_party/tensorrt/BUILD.tpl              | 1 +
+ third_party/tensorrt/tensorrt_configure.bzl | 2 ++
+ 4 files changed, 7 insertions(+)
+
+diff --git a/tensorflow/tensorflow.bzl b/tensorflow/tensorflow.bzl
+index 6c65964dec..a8467cb6a7 100644
+--- a/tensorflow/tensorflow.bzl
++++ b/tensorflow/tensorflow.bzl
+@@ -868,6 +868,7 @@ def tf_gen_op_wrappers_cc(
+             clean_dep("//tensorflow/core:portable_tensorflow_lib"),
+         ]),
+         copts = tf_copts(),
++        linkopts = ['-lrt'],
+         alwayslink = 1,
+         visibility = visibility,
+         compatible_with = compatible_with,
+@@ -886,6 +887,7 @@ def tf_gen_op_wrappers_cc(
+             clean_dep("//tensorflow/core:portable_tensorflow_lib"),
+         ]),
+         copts = tf_copts(),
++        linkopts = ['-lrt'],
+         alwayslink = 1,
+         visibility = [clean_dep("//tensorflow:internal")],
+         compatible_with = compatible_with,
+diff --git a/third_party/gpus/find_cuda_config.py b/third_party/gpus/find_cuda_config.py
+index 80f343023c..6a85107a65 100644
+--- a/third_party/gpus/find_cuda_config.py
++++ b/third_party/gpus/find_cuda_config.py
+@@ -587,6 +587,8 @@ def find_cuda_config():
+     if tuple(int(v) for v in cuda_version.split(".")) < (10, 1):
+       # Before CUDA 10.1, cuBLAS was in the same directory as the toolkit.
+       cublas_paths = cuda_paths
++
++    cublas_paths = cuda_paths
+     cublas_version = os.environ.get("TF_CUBLAS_VERSION", "")
+     result.update(
+         _find_cublas_config(cublas_paths, cublas_version, cuda_version))
+diff --git a/third_party/tensorrt/BUILD.tpl b/third_party/tensorrt/BUILD.tpl
+index dfa06ced2e..0b386f93db 100644
+--- a/third_party/tensorrt/BUILD.tpl
++++ b/third_party/tensorrt/BUILD.tpl
+@@ -25,6 +25,7 @@ cc_library(
+     srcs = [":tensorrt_lib"],
+     copts = cuda_default_copts(),
+     data = [":tensorrt_lib"],
++    linkopts = ['-L/usr/lib64'],
+     linkstatic = 1,
+     deps = [
+         ":tensorrt_headers",
+diff --git a/third_party/tensorrt/tensorrt_configure.bzl b/third_party/tensorrt/tensorrt_configure.bzl
+index 9c980a92cf..deafd2a5a8 100644
+--- a/third_party/tensorrt/tensorrt_configure.bzl
++++ b/third_party/tensorrt/tensorrt_configure.bzl
+@@ -101,6 +101,8 @@ def _create_local_tensorrt_repository(repository_ctx):
+ 
+     # Copy the library and header files.
+     libraries = [lib_name(lib, cpu_value, trt_version) for lib in _TF_TENSORRT_LIBS]
++    libraries.append("libmemcpy-2.14.so")
++    libraries.append("libmyelin.so.1")
+     library_dir = config["tensorrt_library_dir"] + "/"
+     headers = _get_tensorrt_headers(trt_version)
+     include_dir = config["tensorrt_include_dir"] + "/"
+-- 
+2.27.0
+
-- 
2.27.0

